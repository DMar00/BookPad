package integrazione;

import bean.Story;
import bean.User;
import com.mysql.cj.jdbc.MysqlDataSource;
import control.authentication.LoginServlet;
import control.authentication.RegServlet;
import control.story.WriteStoryServlet;
import dao.StoryDAO;
import dao.UserDAO;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.mock.web.MockHttpServletRequest;
import org.springframework.mock.web.MockHttpServletResponse;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.ArrayList;

import static org.junit.Assert.*;
import static org.mockito.Mockito.*;

public class TestPubblicaStoria extends RegServlet {
    private static MysqlDataSource mds;
    private UserDAO userDao;
    private MockHttpServletRequest request;
    private MockHttpServletResponse response;
    private WriteStoryServlet servlet;
    private StoryDAO storyDao;

    @BeforeEach
    void setUp() throws Exception {
        request = new MockHttpServletRequest();
        response = new MockHttpServletResponse();

        mds = new MysqlDataSource();
        mds.setUrl("jdbc:mysql://localhost:3306/bookpadtest");
        mds.setUser("admin");
        mds.setPassword("adminPass");

        RequestDispatcher rd = mock(RequestDispatcher.class);
        doNothing().when(rd).forward(isA(HttpServletRequest.class), isA(HttpServletResponse.class));

        ServletContext ctx = mock(ServletContext.class);
        when(ctx.getAttribute("dataSource")).thenReturn(mds);
        when(ctx.getRequestDispatcher(isA(String.class))).thenReturn(rd);
        servlet = new WriteStoryServlet() {
            @Override
            public ServletContext getServletContext() {
                return ctx;
            }
        };

        userDao = new UserDAO(mds);
        storyDao = new StoryDAO(mds);
    }

    @Test
    public void TC_PUB_1() throws ServletException, IOException, SQLException {
        User u = userDao.register("anna@libero.it", "Giovannino!", "giovy");

        String titolo = "Titolo storia di Giovanninooooooooooooooooooooooooooooooooooooooooo";
        request.setParameter("titolo", titolo);
        request.setParameter("trama", "Storia interessante");
        request.setParameter("genere", "Horror");
        request.setParameter("chap_title", new String[]{"Capitolo 0"});
        request.setParameter("chap_text", new String[]{"Capitolo 0 contenuto.."});

        servlet.doPost(request, response);

        ArrayList<Story> stories = (ArrayList<Story>) storyDao.getPublishedStories(u);
        boolean found = false;
        for (Story s : stories) {
            if (s.getTitle().equals(titolo)) {
                found = true;
            }
        }
        assertFalse(found);

    }

    @Test
    public void TC_PUB_2() throws SQLException, ServletException, IOException {
        User u = userDao.register("anna@libero.it", "Giovannino!", "giovy");

        String titolo = "Titolo storia di Giovannino";
        request.setParameter("titolo", titolo);
        request.setParameter("trama", "Storia interessante..........................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                "...................................................................................................." +
                ".........................................");
        request.setParameter("genere", "Horror");
        request.setParameter("chap_title", new String[]{"Capitolo 0"});
        request.setParameter("chap_text", new String[]{"Capitolo 0 contenuto.."});


        servlet.doPost(request, response);

        ArrayList<Story> stories = (ArrayList<Story>) storyDao.getPublishedStories(u);
        boolean found = false;
        for (Story s : stories) {
            if (s.getTitle().equals(titolo)) {
                found = true;
            }
        }
        assertFalse(found);

    }

    @Test
    public void TC_PUB_3() throws ServletException, IOException, SQLException {
        User u = userDao.register("anna@libero.it", "Giovannino!", "giovy");

        String titolo = "Titolo storia di Giovannino";
        request.setParameter("titolo", titolo);
        request.setParameter("trama", "Storia interessante");
        request.setParameter("genere", "Horr");
        request.setParameter("chap_title", new String[]{"Capitolo 0"});
        request.setParameter("chap_text", new String[]{"Capitolo 0 contenuto.."});


        servlet.doPost(request, response);

        ArrayList<Story> stories = (ArrayList<Story>) storyDao.getPublishedStories(u);
        boolean found = false;
        for (Story s : stories) {
            if (s.getTitle().equals(titolo)) {
                found = true;
            }
        }
        assertFalse(found);

    }

    @Test
    public void TC_PUB_4() throws ServletException, IOException, SQLException {
        User u = userDao.register("anna@libero.it", "Giovannino!", "giovy");
        request.getSession().setAttribute("user_logged",u);

        String titolo = "Titolo storia di Giovannino";
        request.setParameter("titolo", titolo);
        request.setParameter("trama", "Storia interessante");
        request.setParameter("genere", "Horror");
        request.setParameter("chap_title", new String[]{});
        request.setParameter("chap_text", new String[]{"Capitolo 0 contenuto.."});


        servlet.doPost(request, response);

        ArrayList<Story> stories = (ArrayList<Story>) storyDao.getPublishedStories(u);
        boolean found = false;
        for (Story s : stories) {
            if (s.getTitle().equals(titolo)) {
                found = true;
            }
        }
        assertFalse(found);

    }

    @Test
    public void TC_PUB_5() throws ServletException, IOException, SQLException {
        User u = userDao.register("anna@libero.it", "Giovannino!", "giovy");
        request.getSession().setAttribute("user_logged",u);

        String titolo = "Titolo storia di Giovannino";
        request.setParameter("titolo", titolo);
        request.setParameter("trama", "Storia interessante");
        request.setParameter("genere", "Horror");
        request.setParameter("chap_title", new String[]{
                "Capitoloooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo 0"});
        request.setParameter("chap_text", new String[]{"Capitolo 0 contenuto.."});


        servlet.doPost(request, response);

        ArrayList<Story> stories = (ArrayList<Story>) storyDao.getPublishedStories(u);
        boolean found = false;
        for (Story s : stories) {
            if (s.getTitle().equals(titolo)) {
                found = true;
            }
        }
        assertFalse(found);

    }

    @Test
    public void TC_PUB_6() throws ServletException, IOException, SQLException {
        User u = userDao.register("anna@libero.it", "Giovannino!", "giovy");
        request.getSession().setAttribute("user_logged",u);

        String titolo = "Titolo storia di Giovannino";
        request.setParameter("titolo", titolo);
        request.setParameter("trama", "Storia interessante");
        request.setParameter("genere", "Horror");
        request.setParameter("chap_title", new String[]{"Capitolo 0"});
        request.setParameter("chap_text", new String[]{"Capitolo 0 contenuto..", "Capitolo 1 contenuto.."});


        servlet.doPost(request, response);

        ArrayList<Story> stories = (ArrayList<Story>) storyDao.getPublishedStories(u);
        boolean found = false;
        for (Story s : stories) {
            if (s.getTitle().equals(titolo)) {
                found = true;
            }
        }
        assertFalse(found);
    }

    @Test
    public void TC_PUB_7() throws ServletException, IOException, SQLException {
        User u = userDao.register("anna@libero.it", "Giovannino!", "giovy");
        request.getSession().setAttribute("user_logged",u);

        String titolo = "Titolo storia di Giovannino";
        request.setParameter("titolo", titolo);
        request.setParameter("trama", "Storia interessante");
        request.setParameter("genere", "Horror");
        request.setParameter("chap_title", new String[]{"Capitolo 0"});
        request.setParameter("chap_text", new String[]{""});


        servlet.doPost(request, response);

        ArrayList<Story> stories = (ArrayList<Story>) storyDao.getPublishedStories(u);
        boolean found = false;
        for (Story s : stories) {
            if (s.getTitle().equals(titolo)) {
                found = true;
            }
        }
        assertFalse(found);
    }

    @Test
    public void TC_PUB_8() throws ServletException, IOException, SQLException {
        User u = userDao.register("anna@libero.it", "Giovannino!", "giovy");
        request.getSession().setAttribute("user_logged",u);

        String titolo = "Questo Titolo storia di Giovannino";
        request.setParameter("titolo", titolo);
        request.setParameter("trama", "Storia interessante");
        request.setParameter("genere", "Horror");
        request.setParameter("chap_title", new String[]{"Capitolo 0"});
        request.setParameter("chap_text", new String[]{"Capitolo 0 contenuto.."});

        servlet.doPost(request, response);

        ArrayList<Story> stories = (ArrayList<Story>) storyDao.getPublishedStories(u);
        System.out.println(storyDao.getByTitle(titolo));
        boolean found = false;
        for (Story s : stories) {
            if (s.getTitle().equals(titolo)) {
                found = true;
            }
        }
        System.out.println(found);
        assertTrue(found);
    }


    @AfterEach
    public void tearDown() throws SQLException {
        request = null;
        response = null;
        removeUsers();
    }

    private void setParameter(HttpServletRequest request, String key, String value) {
        when(request.getParameter(key)).thenReturn(value);
    }

    private void removeUsers() throws SQLException {
        Connection con = mds.getConnection();
        PreparedStatement st = con.prepareStatement("DELETE FROM users WHERE id>0");
        st.executeUpdate();
    }

}
